# Single-stage Dockerfile for In the Loop
# Copies source files and runs the dev server

FROM node:23-alpine
RUN apk add --no-cache bash git && corepack enable && corepack prepare pnpm@latest --activate
WORKDIR /app

# ---
# Install dependencies
# ---

# Copy package files first
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/agent-core/package.json ./packages/agent-core/
COPY packages/ai-core/package.json ./packages/ai-core/
COPY packages/pyodide-runtime/package.json ./packages/pyodide-runtime/
COPY packages/schema/package.json ./packages/schema/

# Install dependencies
RUN pnpm install --no-frozen-lockfile

# ---
# Copy source files
# ---

# Copy everything else (filtered by .dockerignore)
COPY . .

# Override env files from examples
COPY .env.example .env
COPY .dev.vars.example .dev.vars

# ---
# Set environment variables
# ---

# Set git commit hash to avoid git commands in container
ENV VITE_GIT_COMMIT_HASH=docker-build
ENV VITE_API_TARGET=http://sync:8787
ENV VITE_HOST=0.0.0.0

# ---
# Run server
# ---

# Expose port
EXPOSE 5173

# Keep container running for debugging/SSH access
# CMD ["tail", "-f", "/dev/null"]

# Run dev server
CMD ["pnpm", "run", "dev:web", "--port", "5173"]
